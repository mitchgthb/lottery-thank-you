<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Lottery Entry üéüÔ∏è</title>
        <script src="https://www.gstatic.com/firebasejs/9.9.4/firebase-app.js"></script>
        <script src="https://www.gstatic.com/firebasejs/9.9.4/firebase-firestore.js"></script>
        <link rel="stylesheet" href="styles.css">
    </head>
    <body>
        <div class="container">
            <h1>üéüÔ∏è Enter the Lottery!</h1>
            <p>Submit your details to receive a **unique lottery number**.</p>
            
            <form id="lotteryForm" onsubmit="submitForm(event)">
                <label for="name">Name:</label>
                <input type="text" id="name" name="name" required>
    
                <label for="email">Email:</label>
                <input type="email" id="email" name="email" required>
    
                <button type="submit">Get Your Lottery Number üéâ</button>
            </form>
        </div>
        <script>
            import { initializeApp } from "firebase/app";
            import { getAnalytics } from "firebase/analytics";

            const firebaseConfig = {
                apiKey: "AIzaSyAIXobiW1RMtc-la7_YErR3H5_RBCN45as",
                authDomain: "lottery-entry.firebaseapp.com",
                databaseURL: "https://lottery-entry-default-rtdb.europe-west1.firebasedatabase.app",
                projectId: "lottery-entry",
                storageBucket: "lottery-entry.firebasestorage.app",
                messagingSenderId: "262785817899",
                appId: "1:262785817899:web:791916640532e973c3396e",
                measurementId: "G-EF7HJMM2BN"
            };


            firebase.initializeApp(firebaseConfig);
            const db = firebase.firestore();

            async function generateUniqueNumber() {
                let isUnique = false;
                let lotteryNumber;

                while (!isUnique) {
                    lotteryNumber = Math.floor(100000 + Math.random() * 900000); // Generate 6-digit number
                    const snapshot = await db.collection("lotteryEntries").where("lotteryNumber", "==", lotteryNumber).get();
                    isUnique = snapshot.empty; // If no existing entries, it's unique
                }
                return lotteryNumber;
            }

            async function getIPAddress() {
                const response = await fetch("https://api64.ipify.org?format=json");
                const data = await response.json();
                return data.ip;
            }

            function getDeviceInfo() {
                return navigator.userAgent; // Returns browser & device details
            }

            async function generateUniqueNumber() {
                let isUnique = false;
                let lotteryNumber;

                while (!isUnique) {
                    lotteryNumber = Math.floor(100000 + Math.random() * 900000);
                    
                    // Check if the number exists in Firestore
                    const snapshot = await db.collection("lotteryEntries")
                                            .where("lotteryNumber", "==", lotteryNumber)
                                            .get();
                    isUnique = snapshot.empty; // If empty, number is unique
                }
                
                return lotteryNumber;
            }

            async function submitForm(event) {
                event.preventDefault();

                const form = event.target;
                const name = form.name.value;
                const email = form.email.value;

                const lotteryNumber = await generateUniqueNumber();
                const ipAddress = await getIPAddress();
                const deviceInfo = getDeviceInfo();

                // Save entry to Firestore
                await db.collection("lotteryEntries").add({
                    name,
                    email,
                    lotteryNumber,
                    ipAddress,
                    deviceInfo,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                });

                // Redirect to Thank You page with lottery number
                window.location.href = `thank-you.html?number=${lotteryNumber}`;
            }
        </script>
    </body>
</html>
